<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Web Engineering Textbook: Authentication from Scratch</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />

  <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />

  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>
<body class="guide">
  <div>
    <a href="http://github.com/backend-development/backend-development-textbook/"><img style="position: fixed; top: 0; right: 0; border: 0; z-index: 10;" src="images/forkme.png" alt="Fork me on GitHub"></a>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Learn more at the sources: </strong>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://git-scm.com/documentation">Git Documentation</a></li>
        <li class="more-info"><a href="http://try.github.com/">Try Git</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/">Ruby on Rails</a></li>
        <li class="more-info"><a href="http://guides.rubyonrails.org/">Rails Guides</a></li>
        <li class="more-info"><a href="http://railsforzombies.org/">Rails for Zombies</a></li>
        <li class="more-info"><a href="http://railscasts.com/">Railscasts</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Return to home page">Backend<span> Development</span></a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" onclick="guideMenu(); return false;" id="guidesMenu" class="guides-index-item nav-item">Index  &#x25BC;</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>Ruby on Rails 1</dt>
                <dd><a href="ruby_commandline.html">Ruby Commandline</a></dd>
                <dd><a href="rails_database_and_model.html">Rails Database and Models</a></dd>
                <dd><a href="rails_view_and_controller.html">Rails View and Controller</a></dd>
                <dd><a href="authentication_from_scratch.html">Authentication</a></dd>
                <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                <dd><a href="javascript_and_ajax.html">Javascript and AJAX</a></dd>
                <dd><a href="testing.html">Getting started with Testing</a></dd>
                <dd><a href="rails_gems.html">Ruby Gems for your Rails Project</a></dd>
                <dt>Ruby on Rails 2</dt>
                <dd><a href="rails_advanced_models.html">Advanced Rails Models</a></dd>
                <dd><a href="testing_with_rspec.html">Testing with RSpec</a></dd>
                <dd><a href="advanced_testing.html">Advanced testing</a></dd>
                <dd><a href="internationalization.html">Internationalization (I18n)</a></dd>
                <dd><a href="security.html">Security</a></dd>
                <dd><a href="deploying_rails.html">Deploying Rails with Capistrano</a></dd>
              </dl>
              <dl class="R">
                <dt>Git</dt>
                <dd><a href="git_basics.html">Git Basics</a></dd>
                <dd><a href="git_branching.html">Branching and Merging</a></dd>
                <dd><a href="git_teamwork.html">Teamwork</a></dd>
                <dt>Software Process</dt>
                <dd><a href="refactoring_rails.html">Refactoring Rails</a></dd>
              </dl>
          </div>
        </li>
        <li><a class="nav-item" href="https://github.com/backend-development/backend-development-textbook/">Contribute</a></li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<ol class="chapters">
<li><a href="#sessions-in-rails">Sessions in Rails </a></li>
<li><a href="#virtual-attributes">Virtual Attributes </a></li>
<li>
<a href="#password-storage">Password Storage</a>

<ul>
<li><a href="#has-secure-password">has secure password</a></li>
<li><a href="#validates-confirmation-of-password">validates confirmation of password</a></li>
</ul>
</li>
<li><a href="#login-from-scratch">Login from Scratch</a></li>
<li><a href="#login-using-twitter-facebook-github">Login using twitter, facebook, github, ...</a></li>
<li><a href="#confirmation-e-mail-password-reminder">Confirmation E-Mail, Password Reminder, ...</a></li>
<li><a href="#further-reading">Further Reading</a></li>
</ol>
</body></html>

          </div>

      <h2>Authentication from Scratch</h2><p>This guide is about Logins and Logouts.</p><p>After reading this guide you will</p>
<ul>
<li>understand how cookies, sessions, logins are connected</li>
<li>be able to build a rails app with simple login and logout</li>
<li>be able to use other authentication providers</li>
<li>be able to offer password reminders to your users</li>
</ul>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<h3 id="sessions-in-rails">1 Sessions in Rails </h3>
<p>HTTP is a <strong>stateless</strong> protocol. This means that the web server
does not need to remember anything about the client from one
request to the next.  </p>
<p>Building a Login for your web app means getting around the
statlessness, creating a way for the web app to remember: oh, this is user
Susan, I already know her, she has these three things in her shopping cart
and is allowed to view this secret page.</p>
<p>Cookies are a way to achive statefulness in HTTP. A cookie
is an abitrary piece of information that the server sends to the
client, and that the client will echo back with every request.</p>
<p><img src="images/cookie-in-ff-inspector.png" alt="cookie set by rails,  as displayed by firebug"></p>
<p>Web frameworks use cookies to offer so called <strong>sessions</strong> to the
developer: a session is a key-value store that is associated with
the cookie, and thus with one specific user.</p>
<p>Ruby on Rails by default sets a cookie named after the application.
In the above screenshot you can see the cookie set by the <code>wichteln</code>
application as displayed by firebug storage inspector, below the same cookie
in chrome developer tools.</p>
<p><img src="images/cookie-in-chrome.png" alt="cookie set by rails,  as displayed by chrome"></p>
<p>If you copy over this cookie to another browser, you are getting access to
the session in that new browser!</p>
<p>When programming the backend In Ruby on Rails you 
find a Hash <code>session</code> that is accessible from
both controllers and views.</p>
<p>See <a href="http://guides.rubyonrails.org/action_controller_overview.html#session">Rails Guide: Controller</a>
for more details.</p>
<h3 id="virtual-attributes">2 Virtual Attributes </h3>
<p>When building your first rails app with the scaffolds generator
or the model generator you immediately see how tightly the
rails model is connected to the database table.</p>
<p>But there is more to the model than just that.  The model 
is a ruby class. You can use it to add the so called "business logic"
to your model:  for a model representing a book in the library
this would be methods for checking out and handing in the book, .... for
every model this will be different.</p>
<p>In many cases you want the object from your model class 
to have a different set of attributes than the underlying database has.
To achieve this disconnect we will look into virtual attributes </p>
<p>In the following example the attribute <code>fullname</code>
is computed from two other attributes, and does not really
exist in the database:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
attr_accessible :firstname, :lastname, :fullname

def fullname
  "#{firstname} #{lastname}"
end

</pre>
</div>
<p>To set the attribute 
is computed from two other attributes, does not really
exist in the database.</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def fullname=(name)
  split = name.split(' ', 2)
  self.firstname = split.first
  self.lastname = split.last
end

</pre>
</div>
<p>See <a href="http://railscasts.com/episodes/16-virtual-attributes?view=asciicast">Railscast no.16</a> for
more details on virtual attributes.</p>
<h3 id="password-storage">3 Password Storage</h3>
<h4 id="has-secure-password">3.1 has secure password</h4>
<p>Rails comes with the following automatism for handling passwords,
which go a long way to following the <a href="https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet">OWASP recommendations</a>.</p>
<p>It assumes that you have an attribute "password_digest"
in your database (and no attribute "password").</p>
<p>You can use it like this: Add the gem 'bcrypt' to the Gemfile, and
<code>has_secure_password</code> to your user model:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_secure_password

</pre>
</div>
<p>Now if you call </p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
User.create({username: "mariam", password: 'badpassword123' })

</pre>
</div>
<p>The password will be encrypted, and only the encrypted version
will be stored in the database.</p>
<p>It will add the <code>authenticate</code> method to your User model:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
user = User.find(username: "USERNAME").authenticate("THE PASSWORD") 

</pre>
</div>
<p>The authenticate method will encrypt the password again, and compare
it to the password_digest in the database.  It will return nil if
the password does not match.</p>
<h4 id="validates-confirmation-of-password">3.2 validates confirmation of password</h4>
<p>It is good UX practice to have users supply their
password twice, to make it less likely that typoes go through.
Rails also helps you with this:  You can add <code>validates_confirmation_of :password</code>
to the user model:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
    has_secure_password
    validates_confirmation_of :password

</pre>
</div>
<p>Now the create-method is changed again: you need to supply the
passwort twice to the create method:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
User.create({username: "mariam",
    password: 'badpassword123',
    password_confirmation: 'badpassword1234'})

</pre>
</div>
<p>This use of create will not actually succeed, because the password_confirmation does
not match the password.</p>
<h3 id="login-from-scratch">4 Login from Scratch</h3>
<p>We now have all the bits and pieces to build a Login.  </p>
<p>There are some rails convention around this:</p>
<ul>
<li>the current user should be accessible via a helper method <code>current_user</code>,</li>
<li>login in and login out is seen as "creating a session" and "deleting a session" and handled by restful routes,</li>
<li>there is a session controller and some views, but no model!</li>
</ul>
<p>Let's start by creating the routes:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/routes.rb:
  get  '/login'  =&gt; 'sessions#new'
  post '/login'  =&gt; 'sessions#create'
  get  '/logout' =&gt; 'sessions#destroy'

</pre>
</div>
<p>and the session controller to handle this routes:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
rails g controller sessions new create destroy

</pre>
</div>
<p>Now you can direct your browser to <a href="http://localhost:3000/login">http://localhost:3000/login</a>
Next you need to set up the view for the login form there: </p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
&lt;!-- app/views/session/new.html.erb: --&gt;

&lt;h1&gt;Log in&lt;/h1&gt;

&lt;%= form_tag login_path do |f| %&gt;
    E-Mail:   &lt;%= text_field_tag     :email    %&gt; &lt;br&gt;
    Password: &lt;%= password_field_tag :password %&gt; &lt;br&gt;
    &lt;%= submit_tag 'Log In' %&gt;
&lt;% end %&gt;

</pre>
</div>
<p>This form sends just two pieces of data: <code>email</code> and <code>password</code>.
So in the controller you have to extract these using <code>params.permit</code>.</p>
<p>If authentication goes through we store the user.id in the session.
Only the id is needed, we can load everything else from the database later.</p>
<p>app/app/controllers/sessions_controller.rb:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class SessionsController &lt; ApplicationController

  # displays login form
  def new
  end

  # checks login data and starts session
  def create
    par = login_params
    user = User.find_by(email: par[:email])
    if user &amp;&amp; user.authenticate(par[:password])
      # Save the user id inside the browser cookie. 
      # This is how we keep the user # logged in 
      # when they navigate around our website.
      session[:user_id] = user.id
      redirect_to root_path, notice: 'Logged in'
    else
      redirect_to login_path, alert: 'Log in failed'
    end
  end

  # deletes sesssion
  def destroy
    session[:user_id] = nil
    redirect_to login_path, notice: 'Logged out' 
  end

private

  def login_params
    params.permit(:email, :password)
  end
end

</pre>
</div>
<p>The helper_method <code>current_user</code> we define in 
the application controller.  If the user_id is not
set in the session or if the user with this id does not
exist (any more) we just return nil as the current_user.</p>
<p>app/app/controllers/application_controller.rb:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def current_user
  @current_user = nil
  if session[:user_id]
    @current_user ||= User.where(id: session[:user_id]).first 
  end
end
helper_method :current_user

</pre>
</div>
<p>With the current_user helper method returning nil if
nobody is logged in we can also use it in the view
to display different things for logged in users and non logged in visitors:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
&lt;!-- app/views/layouts/application.html.erb --&gt;
&lt;% if current_user %&gt; 
  Logged in as &lt;%= current_user.name %&gt; 
  &lt;%= link_to "log out", logout_path %&gt;
&lt;% else %&gt;
  &lt;%= link_to "log in", login_path %&gt;
  | &lt;%= link_to "register", new_user_path %&gt;
&lt;% end %&gt;

</pre>
</div>
<h3 id="login-using-twitter-facebook-github">5 Login using twitter, facebook, github, ...</h3>
<p>In many scenarios it might be more convenient for your users
to not have to register on your site, but to use another service
to authenticate.  That way they don't have to remember another password.
And you might not have to handle passwords at all.</p>
<p>The gem <code>omniauth</code> helps you deal with OAuth2, OpenID, LDAP, and many
other authentication providers.  The <a href="https://github.com/intridea/omniauth/wiki/List-of-Strategies">list of strategies</a>
is quite impressive.  Think carefully about what services your users
are using, and which services might be useful to your app: could
you use Dropbox to authenticate, and also to deliver data directly
to your users dropbox? Would it make sense to use facebook or twitter and also
send out messages that way?  </p>
<p>You will have to register your app with the authentication
provider, eg. at <a href="https://developers.facebook.com/apps/">https://developers.facebook.com/apps/</a> 
or <a href="https://apps.twitter.com/">https://apps.twitter.com/</a>.
For every provider you get two pieces of information: a key and a secret.
These you add to the configuration of omniauth:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/initializers/omniauth.rb:

Rails.application.config.middleware.use OmniAuth::Builder do
  provider :twitter, 'TWITTER_KEY', 'TWITTER_SECRET'
end

</pre>
</div>
<p>If you plan on publishing your source code (e.g. because you use github for free ;-)
you might want to set these values in a way that is NOT saved to the repository.
You could use environment variables for that:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/initializers/omniauth.rb:

Rails.application.config.middleware.use OmniAuth::Builder do
  provider :twitter, ENV['TWITTER_KEY'], ENV['TWITTER_SECRET']
end

</pre>
</div>
<p>For authentication you need to save at least the provider and the uid in your database
somewhere.  But you can get more information out of the authentication:
name, e-mail, and the token and secret needed to actually use the service.</p>
<p>If you will only use one service, you can save the information directly
in the user model.  But it might be more prudent to plan for different authentication
methods, and create a separate Authentication model. This way you can
let users choose one of several authentication methods.</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# created with
# rails g migration CreateAuthentication provider uid user:references token secret

class CreateAuthentication &lt; ActiveRecord::Migration
  def change
    create_table :authentications do |t|
      t.string :provider
      t.string :uid
      t.references :user, index: true, foreign_key: true
      t.string :token
      t.string :secret
    end
  end
end

</pre>
</div>
<p>The <code>uid</code> is unique within each provider. There is only one
user with id <code>42</code> at twitter, but there might be a users with the
same desigation at facebook.</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/model/authentication.rb
class Authentication &lt; ActiveRecord::Base
  belongs_to :user  # also add has_many to users model!
  validates :provider, :uid, presence: true
  validates :uid, uniqueness: { scope: :provider }
end

</pre>
</div>
<p>Omniauth is a "Rack Middleware". That means it is somewhat independant
of the rails app you are building.  It has access to the HTTP request, will
analyze that, and pass on data to your rails app through the environment variable <code>omniauth.auth</code>.</p>
<p>To log in you send the user to <code>/auth/:provider</code> (e.g. <code>/auth/facebook</code>).</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
&lt;!-- app/views/layouts/application.html.erb --&gt;
  &lt;% if current_user %&gt; 
    Logged in as &lt;%= current_user.name %&gt; 
    &lt;%= link_to "log out", logout_path %&gt;
  &lt;% else %&gt;
    &lt;%= link_to "log in with twitter", "/auth/twitter" %&gt;
  &lt;% end %&gt;

</pre>
</div>
<p>This URL is handled by omniauth, not by your rails app.  omniauth will send
the users browser on to a URL at the provider.  There the user can log in. After
that the browser is redirected to your app again, to <code>/auth/:provider/callback</code></p>
<p>This URL you need to map to the session controller:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/routes.rb:
match '/auth/:provider/callback', to: 'sessions#create',  via: [:get, :post]
match '/auth/failure',            to: 'sessions#failure', via: [:get, :post]

</pre>
</div>
<p>In the session controller you can now read the data that omniauth provides
from the environment variable.  As a first step you could just print it out,
to see what data is provided:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def create
  render :text =&gt; "&lt;pre&gt;" + env["omniauth.auth"].to_yaml and return
end

</pre>
</div>
<p>There are two basic cases to consider: either the user has logged in using
this authorisation method before (then we should find that in our database),
or they are logging in for the first time.</p>
<p>This can get quite involved, so we hide it away inside the user model:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def create
  user = User.find_or_create_with_omniauth( request.env['omniauth.auth'] )

  if user 
    session[:user_id] = user.id
    redirect_to root_path, notice: 'Logged in'
  else
    redirect_to login_path, alert: 'Log in failed'
  end
end

</pre>
</div>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/model/user.rb

def self.find_or_create_with_omniauth(auth)
  # look for an existing authorisation 
  # provider + uid uniquely identify a user
  a = Authentication.find_or_create_by( 
         provider: auth['provider'], 
         uid:      auth['uid'] 
  )
  # save other info you want to remember:
  a.update( secret: auth["credentials"]["secret"],  
            token:  auth["credentials"]["token"]  )
  a.save!

  if a.user.nil? 
    # all new user
    u = create! do |user|
      user.uid      = auth["uid"]
      user.name     = auth["info"]["name"]
    end

    a.user = u
    a.save!
  end

  return a.user
end # def self.find_or_create_with_omniauth(auth)

</pre>
</div>
<p>The method <code>find_or_create_by</code> handles both cases in one: either it
finds an existing authentication or it creates a new one.</p>
<h3 id="confirmation-e-mail-password-reminder">6 Confirmation E-Mail, Password Reminder, ...</h3>
<p>If you want to stick with registering users in your own app
the gem <code>devise</code> offers a lot of features. It makes your logins ...</p>
<ul>
<li>Confirmable: sends emails with confirmation instructions and verifies whether an account is already confirmed during sign in.</li>
<li>Recoverable: resets the user password and sends reset instructions.</li>
<li>Registerable: handles signing up users through a registration process, also allowing them to edit and destroy their account.</li>
<li>Rememberable: manages generating and clearing a token for remembering the user from a saved cookie.</li>
<li>Trackable: tracks sign in count, timestamps and IP address.</li>
<li>Timeoutable: expires sessions that have not been active in a specified period of time.</li>
<li>Validatable: provides validations of email and password. It's optional and can be customized, so you're able to define your own validations.</li>
<li>Lockable: locks an account after a specified number of failed sign-in attempts. Can unlock via email or after a specified time period.</li>
</ul>
<p>Devise can also be combined with omniauth:</p>
<ul>
<li>Omniauthable: adds OmniAuth support.</li>
</ul>
<h3 id="further-reading">7 Further Reading</h3>
<ul>
<li>OmniAuth <a href="https://github.com/intridea/omniauth/wiki">wiki</a>
</li>
<li>Devise <a href="https://github.com/plataformatec/devise">github page</a>
</li>
<li>Rails Security Guide on <a href="http://guides.rubyonrails.org/security.html#user-management">User Management</a>
</li>
</ul>
</body></html>

      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p class="copyright">published under <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/at/deed.de">creative commons by-nc-sa</a> in 2012-2015 by <a href="http://brigitte-jellinek.at">Brigitte Jellinek</a>.
      </p><p>If you want to contribute: <a href="https://github.com/backend-development/backend-development-textbook/fork">fork the source on github</a>
        and edit <a href="https://github.com/backend-development/backend-development-textbook/blob/master/source/authentication_from_scratch.md">authentication_from_scratch.md</a>
      </p>
    </div>
  </div>

  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all()
    $(guidesIndex.bind);
  </script>
  </body>
</html>
